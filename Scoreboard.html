<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"
        integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Coda+Caption:wght@800&display=swap');

        .player-card {
            border: 1px solid black;
            height: 150px;
            width: 400px;
        }

        .player-card-heading {
            font-family: 'Coda Caption', sans-serif;
            height: 30%;
            max-width: 100%;
            color: white;
            font-size: 24px;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .player-card-stats {
            font-family: 'Coda Caption', sans-serif;
            height: 45%;
            max-width: 100%;
            color: white;
            font-size: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 10px;
        }

        .stat-item {
            text-align: center;
            margin-left: 10px;
            margin-right: 10px;
        }

        .stat-item p {
            margin: 0;
        }

        .player-card-boost {
            height: 25%;
            max-width: 100%;
            background-color: white;
            font-family: 'Coda Caption', sans-serif;
            font-size: 24px;
        }

        .boost-value {
            height: 100%;
            width: 33%;
            background-color: #f5be27;
            color: black;
        }
    </style>
</head>

<body style="background-color: black;">
    <!-- <video id="game-start-video" style="display: none;" height="100%" width="100%" id="game-start" autoplay muted>
        <source src="Intro.webm" type="video/webm">
    </video> -->

    <div class="scoreboard" style="position: fixed; bottom: 50px; left: 50px;">
        <img src="Scoreboard.png">
        <p id="orange-score"
            style="position: fixed; bottom:  62px; left: 394px; color: white; font-size: 64px; font-weight: bold;">0
        </p>
        <p id="blue-score"
            style="position: fixed; bottom: -10px; left: 394px; color: white; font-size: 64px; font-weight: bold;">0
        </p>
        <p id="game-time"
            style="position: fixed; bottom: 27px; left: 454px; color: black; font-size: 64px; font-weight: bold;">5:00
        </p>
    </div>

    <div style="position: fixed; bottom: 50px; right: 50px;">
        <div id="blue-card" class="player-card" style="display: block;">
            <div id="blue-card-name" class="player-card-heading" style="background-color: #1167b1;">
                Player Name
            </div>
            <div class="player-card-stats" style="background-color: #187bcd;">
                <div class="stat-item">
                    <p>Score</p>
                    <p id="blue-card-score">100</p>
                </div>
                <div class="stat-item">
                    <p>Goals</p>
                    <p id="blue-card-goals">0</p>
                </div>
                <div class="stat-item">
                    <p>Assists</p>
                    <p id="blue-card-assists">0</p>
                </div>
                <div class="stat-item">
                    <p>Saves</p>
                    <p id="blue-card-saves">0</p>
                </div>
            </div>
            <div class="player-card-boost">
                <div id="blue-card-boost-vis" class="boost-value">
                    <div id="blue-card-boost-num" style="position: absolute; left: 50%;">75</div>
                </div>
            </div>
        </div>

        <div id="orange-card" class="player-card" style="display: none;">
            <div id="orange-card-name" class="player-card-heading" style="background-color: #D32F2F;">
                Player Name
            </div>
            <div class="player-card-stats" style="background-color: #EF5350;">
                <div class="stat-item">
                    <p>Score</p>
                    <p id="orange-card-score">100</p>
                </div>
                <div class="stat-item">
                    <p>Goals</p>
                    <p id="orange-card-goals">0</p>
                </div>
                <div class="stat-item">
                    <p>Assists</p>
                    <p id="orange-card-assists">0</p>
                </div>
                <div class="stat-item">
                    <p>Saves</p>
                    <p id="orange-card-saves">0</p>
                </div>
            </div>
            <div class="player-card-boost">
                <div id="orange-card-boost-vis" class="boost-value">
                    <div id="orange-card-boost-num" style="position: absolute; left: 50%;">75</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const WsSubscribers = {
            __subscribers: {},
            websocket: undefined,
            webSocketConnected: false,
            registerQueue: [],
            init: function (port, debug, debugFilters) {
                port = port || 49322;
                debug = debug || false;
                if (debug) {
                    if (debugFilters !== undefined) {
                        console.warn(
                            "WebSocket Debug Mode enabled with filtering. Only events not in the filter list will be dumped"
                        );
                    } else {
                        console.warn(
                            "WebSocket Debug Mode enabled without filters applied. All events will be dumped to console"
                        );
                        console.warn(
                            "To use filters, pass in an array of 'channel:event' strings to the second parameter of the init function"
                        );
                    }
                }
                WsSubscribers.webSocket = new WebSocket("ws://localhost:" + port);
                WsSubscribers.webSocket.onmessage = function (event) {
                    let jEvent = JSON.parse(event.data);
                    if (!jEvent.hasOwnProperty('event')) {
                        return;
                    }
                    let eventSplit = jEvent.event.split(':');
                    let channel = eventSplit[0];
                    let event_event = eventSplit[1];
                    if (debug) {
                        if (!debugFilters) {
                            console.log(channel, event_event, jEvent);
                        } else if (debugFilters && debugFilters.indexOf(jEvent.event) < 0) {
                            console.log(channel, event_event, jEvent);
                        }
                    }
                    WsSubscribers.triggerSubscribers(channel, event_event, jEvent.data);
                };
                WsSubscribers.webSocket.onopen = function () {
                    WsSubscribers.triggerSubscribers("ws", "open");
                    WsSubscribers.webSocketConnected = true;
                    WsSubscribers.registerQueue.forEach((r) => {
                        WsSubscribers.send("wsRelay", "register", r);
                    });
                    WsSubscribers.registerQueue = [];
                };
                WsSubscribers.webSocket.onerror = function () {
                    WsSubscribers.triggerSubscribers("ws", "error");
                    WsSubscribers.webSocketConnected = false;
                };
                WsSubscribers.webSocket.onclose = function () {
                    WsSubscribers.triggerSubscribers("ws", "close");
                    WsSubscribers.webSocketConnected = false;
                };
            },
            /**
             * Add callbacks for when certain events are thrown
             * Execution is guaranteed to be in First In First Out order
             * @param channels
             * @param events
             * @param callback
             */
            subscribe: function (channels, events, callback) {
                if (typeof channels === "string") {
                    let channel = channels;
                    channels = [];
                    channels.push(channel);
                }
                if (typeof events === "string") {
                    let event = events;
                    events = [];
                    events.push(event);
                }
                channels.forEach(function (c) {
                    events.forEach(function (e) {
                        if (!WsSubscribers.__subscribers.hasOwnProperty(c)) {
                            WsSubscribers.__subscribers[c] = {};
                        }
                        if (!WsSubscribers.__subscribers[c].hasOwnProperty(e)) {
                            WsSubscribers.__subscribers[c][e] = [];
                            if (WsSubscribers.webSocketConnected) {
                                WsSubscribers.send("wsRelay", "register", `${c}:${e}`);
                            } else {
                                WsSubscribers.registerQueue.push(`${c}:${e}`);
                            }
                        }
                        WsSubscribers.__subscribers[c][e].push(callback);
                    });
                })
            },
            clearEventCallbacks: function (channel, event) {
                if (WsSubscribers.__subscribers.hasOwnProperty(channel) && WsSubscribers.__subscribers[channel]
                    .hasOwnProperty(event)) {
                    WsSubscribers.__subscribers[channel] = {};
                }
            },
            triggerSubscribers: function (channel, event, data) {
                if (WsSubscribers.__subscribers.hasOwnProperty(channel) && WsSubscribers.__subscribers[channel]
                    .hasOwnProperty(event)) {
                    WsSubscribers.__subscribers[channel][event].forEach(function (callback) {
                        if (callback instanceof Function) {
                            callback(data);
                        }
                    });
                }
            },
            send: function (channel, event, data) {
                if (typeof channel !== 'string') {
                    console.error("Channel must be a string");
                    return;
                }
                if (typeof event !== 'string') {
                    console.error("Event must be a string");
                    return;
                }
                if (channel === 'local') {
                    this.triggerSubscribers(channel, event, data);
                } else {
                    let cEvent = channel + ":" + event;
                    WsSubscribers.webSocket.send(JSON.stringify({
                        'event': cEvent,
                        'data': data
                    }));
                }
            }
        };


        $(() => {
            WsSubscribers.init(49322, true);
            WsSubscribers.subscribe('game', 'update_state', (x) => {
                //$('.scorebug .team-left .score').text(x['game']['teams'][0]['score']);
                //$('.scorebug .team-right .score').text(x['game']['teams'][1]['score']);
                updatePlayerCard(x);
                updateScore(x);
                updateTime(x);
            });
            WsSubscribers.subscribe('game', 'goal_scored', (x) => {
                // console.log("Goal Scored!");
                // $('#game-start-video').get(0).currentTime = 0;
                // document.getElementById('game-start-video').style.display = "block";
                // setTimeout(function () {
                //     document.getElementById('game-start-video').style.display = "none";
                // }, 5500)
            });

        });

        function updatePlayerCard(data) {
            var playerName = data['game']['target'];

            if (playerName === '') {
                document.getElementById('blue-card').style.display = "none";
                document.getElementById('orange-card').style.display = "none";
            } else {
                if (data['players'][playerName]['team'] == '0') {
                    document.getElementById('blue-card').style.display = "block";
                    document.getElementById('orange-card').style.display = "none";
                    $('#blue-card-name').text(data['players'][playerName]['name']);
                    $('#blue-card-score').text(data['players'][playerName]['score']);
                    $('#blue-card-goals').text(data['players'][playerName]['goals']);
                    $('#blue-card-assists').text(data['players'][playerName]['assists']);
                    $('#blue-card-saves').text(data['players'][playerName]['saves']);
                    document.getElementById('blue-card-boost-vis').style.width = parseInt(data['players'][playerName][
                        'boost'
                    ]) + '%';
                    document.getElementById('blue-card-boost-num').text(data['players'][playerName]['boost']);
                } else {
                    document.getElementById('orange-card').style.display = "block";
                    document.getElementById('blue-card').style.display = "none";
                    $('#orange-card-name').text(data['players'][playerName]['name']);
                    $('#orange-card-score').text(data['players'][playerName]['score']);
                    $('#orange-card-goals').text(data['players'][playerName]['goals']);
                    $('#orange-card-assists').text(data['players'][playerName]['assists']);
                    $('#orange-card-saves').text(data['players'][playerName]['saves']);
                    document.getElementById('orange-card-boost-vis').style.width = parseInt(data['players'][playerName][
                        'boost'
                    ]) + '%';
                    document.getElementById('orange-card-boost-num').text(data['players'][playerName]['boost']);
                }
            }
        }

        function updateTime(data) {
            var timeInSecs = parseFloat(data['game']['time']);
            var minutesRemaining = timeInSecs / 60;
            var secondsRemaining = timeInSecs % 60;

            $('#game-time').text(Math.floor(minutesRemaining) + ':' + secondsRemaining);
        }

        function updateScore(data) {
            var blueScore = data['game']['teams']['0']['score'];
            var redScore = data['game']['teams']['1']['score'];

            // set score
            $('#blue-score').text(blueScore);
            $('#orange-score').text(redScore);
        }
    </script>
</body>

</html>